<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>WWM ‚Äì —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body class="bg-white text-gray-900">
<div class="min-h-screen flex flex-col">
    <header class="border-b border-gray-200 bg-gray-50">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <div>
                <h1 class="text-xl font-semibold text-gray-900">Where Winds Meet ‚Äì —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤</h1>
                <p class="text-xs text-gray-500 mt-1">
                    –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ñ–∞–π–ª–∞–º –ø–µ—Ä–µ–≤–æ–¥–∞
                </p>
            </div>
            <button id="btnRefresh" class="inline-flex items-center rounded border border-gray-800 bg-gray-800 px-3 py-1.5 text-xs font-medium text-gray-50 hover:bg-gray-700">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
    </header>

    <!-- –ü—Ä–µ–ª–æ–∞–¥–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
    <section class="border-b border-gray-200 bg-white">
        <div id="preloader" class="max-w-6xl mx-auto px-4 py-2 flex items-center gap-3 text-xs text-gray-600">
            <div class="w-40 flex-shrink-0 text-[11px] text-gray-500">
                –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–≤–æ–¥–∞...
            </div>
            <div class="flex-1">
                <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                    <div id="preloaderBar" class="bg-gray-800 h-2 rounded-full transition-all" style="width: 0%"></div>
                </div>
            </div>
            <div id="preloaderText" class="w-40 flex-shrink-0 text-right text-[11px] text-gray-500">
                –û–∂–∏–¥–∞–Ω–∏–µ...
            </div>
        </div>
    </section>

    <main class="flex-1 max-w-6xl mx-auto w-full px-4 py-4 space-y-4">
        <!-- –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤ -->
        <section class="border border-gray-200 rounded-lg p-3 bg-gray-50">
            <div class="flex flex-col md:flex-row md:items-end gap-3 md:gap-6">
                <div class="flex-1">
                    <label for="aiFileSelect" class="block text-xs font-medium text-gray-700 mb-1">
                        –ú–∞—à–∏–Ω–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ (AI-—Ñ–∞–π–ª)
                    </label>
                    <select id="aiFileSelect"
                            class="w-full rounded border-gray-300 bg-white text-xs px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-gray-700 focus:border-gray-700">
                    </select>
                </div>
                <div class="flex-1">
                    <label for="langFileSelect" class="block text-xs font-medium text-gray-700 mb-1">
                        –Ø–∑—ã–∫–æ–≤–æ–π —Ñ–∞–π–ª –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                    </label>
                    <select id="langFileSelect"
                            class="w-full rounded border-gray-300 bg-white text-xs px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-gray-700 focus:border-gray-700">
                    </select>
                </div>
            </div>
        </section>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞ -->
        <section class="border border-gray-200 rounded-lg p-4 bg-white">
            <h2 class="text-sm font-semibold text-gray-800 mb-3">–û—Å–Ω–æ–≤–Ω–æ–π –ø–µ—Ä–µ–≤–æ–¥ (translation_ru.tsv)</h2>
            <div id="mainStats" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center p-3 bg-gray-50 rounded">
                    <div class="text-2xl font-bold text-gray-900" id="mainTotal">-</div>
                    <div class="text-xs text-gray-600 mt-1">–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫</div>
                </div>
                <div class="text-center p-3 bg-blue-50 rounded">
                    <div class="text-2xl font-bold text-blue-700" id="mainRU">-</div>
                    <div class="text-xs text-blue-600 mt-1">–†—É—Å—Å–∫–∏–π (RU)</div>
                    <div class="text-xs text-blue-500 mt-1" id="mainRUPercent">-</div>
                </div>
                <div class="text-center p-3 bg-yellow-50 rounded">
                    <div class="text-2xl font-bold text-yellow-700" id="mainEN">-</div>
                    <div class="text-xs text-yellow-600 mt-1">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π (EN)</div>
                    <div class="text-xs text-yellow-500 mt-1" id="mainENPercent">-</div>
                </div>
            </div>
        </section>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ -->
        <section class="border border-gray-200 rounded-lg p-4 bg-white">
            <h2 class="text-sm font-semibold text-gray-800 mb-3" id="langStatsTitle">–ü—Ä–µ–¥–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥</h2>
            <div id="cnStats" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center p-3 bg-gray-50 rounded">
                    <div class="text-2xl font-bold text-gray-900" id="cnTotal">-</div>
                    <div class="text-xs text-gray-600 mt-1">–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫</div>
                </div>
                <div class="text-center p-3 bg-blue-50 rounded">
                    <div class="text-2xl font-bold text-blue-700" id="cnRU">-</div>
                    <div class="text-xs text-blue-600 mt-1">–†—É—Å—Å–∫–∏–π (RU)</div>
                    <div class="text-xs text-blue-500 mt-1" id="cnRUPercent">-</div>
                </div>
                <div class="text-center p-3 bg-yellow-50 rounded">
                    <div class="text-2xl font-bold text-yellow-700" id="cnEN">-</div>
                    <div class="text-xs text-yellow-600 mt-1" id="cnLangLabel">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π (EN)</div>
                    <div class="text-xs text-yellow-500 mt-1" id="cnENPercent">-</div>
                </div>
            </div>
        </section>

        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–∞—à–∏–Ω–Ω–æ–º—É RU -->
        <section class="border border-gray-200 rounded-lg p-4 bg-white">
            <h2 class="text-sm font-semibold text-gray-800 mb-3">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <p class="text-xs text-gray-600 mb-3">
                –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç—Ä–æ–∫ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø–µ—Ä–µ–≤–æ–¥–µ –∏ –º–∞—à–∏–Ω–Ω–æ–º –ø–µ—Ä–µ–≤–æ–¥–µ.
            </p>
            <div id="uniqueStats" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="text-center p-3 bg-green-50 rounded">
                    <div class="text-2xl font-bold text-green-700" id="uniqueTotal">-</div>
                    <div class="text-xs text-green-600 mt-1">–ú–∞—à–∏–Ω–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥</div>
                </div>
                <div class="text-center p-3 bg-blue-50 rounded">
                    <div class="text-2xl font-bold text-blue-700" id="uniqueRU">-</div>
                    <div class="text-xs text-blue-600 mt-1">–° –ú–∞—à–∏–Ω–Ω—ã–º –ø–µ—Ä–µ–≤–æ–¥–æ–º (–≤—Å–µ–≥–æ)</div>
                    <div class="text-xs text-blue-500 mt-1" id="uniqueRUPercent">-</div>
                </div>
                <div class="text-center p-3 bg-yellow-50 rounded">
                    <div class="text-2xl font-bold text-yellow-700" id="uniqueEN">-</div>
                    <div class="text-xs text-yellow-600 mt-1">–û—Å–Ω–æ–≤–Ω–æ–π RU (–æ—Ç –º–∞—à–∏–Ω–Ω–æ–≥–æ RU)</div>
                    <div class="text-xs text-yellow-500 mt-1" id="uniqueENPercent">-</div>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded">
                    <div class="text-2xl font-bold text-gray-900" id="uniqueEmpty">-</div>
                    <div class="text-xs text-gray-600 mt-1">–ú–∞—à–∏–Ω–Ω—ã–π RU —Å–≤–µ—Ä—Ö –æ—Å–Ω–æ–≤–Ω–æ–≥–æ (–æ—Ç –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫)</div>
                </div>
            </div>
        </section>

        <!-- –î–∏–∞–≥—Ä–∞–º–º–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ -->
        <section class="border border-gray-200 rounded-lg p-4 bg-slate-900 text-slate-50">
            <h2 class="text-sm font-semibold mb-3 text-center">–°—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–≤–æ–¥–∞ (—Å—Ç—Ä–æ–∫–∏ —Ç–µ–∫—Å—Ç–∞)</h2>
            <div class="flex flex-col items-center gap-4">
                <div class="w-full max-w-md">
                    <canvas id="statusChart" height="200"></canvas>
                </div>
                <div class="flex flex-wrap justify-center gap-4 text-[11px]">
                    <span class="inline-flex items-center gap-1">
                        <span class="inline-block h-2 w-2 rounded-full bg-cyan-400"></span>
                        <span id="legendMachine">–ú–∞—à–∏–Ω–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥: 0</span>
                    </span>
                    <span class="inline-flex items-center gap-1">
                        <span class="inline-block h-2 w-2 rounded-full bg-emerald-400"></span>
                        <span id="legendEdited">–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥: 0</span>
                    </span>
                    <span class="inline-flex items-center gap-1">
                        <span class="inline-block h-2 w-2 rounded-full bg-fuchsia-400"></span>
                        <span id="legendUntranslated">–ù–µ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ: 0</span>
                    </span>
                </div>
            </div>
        </section>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–≥—Ä—É–∑–∫–µ -->
        <section class="border border-gray-200 rounded-lg p-3 bg-gray-50">
            <div id="loadingInfo" class="text-xs text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </section>
    </main>
</div>

<script>
    // –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã –º–∞—à–∏–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞ (AI)
    const aiFiles = [
        { file: 'grok_and_editing_user_ru.tsv', name: 'Grok + –†–µ–¥–∞–∫—Ç—É—Ä–∞' },
    ];

    // –î–æ—Å—Ç—É–ø–Ω—ã–µ —è–∑—ã–∫–æ–≤—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    const languageFiles = [
        { id: 'ru', file: 'translation_ru.tsv', name: '–û—Å–Ω–æ–≤–Ω–æ–π –ø–µ—Ä–µ–≤–æ–¥ (RU)', code: 'RU' },
        { id: 'en', file: 'translation_en.tsv', name: '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π (EN)', code: 'EN' },
        { id: 'cn', file: 'translation_cn.tsv', name: '–ö–∏—Ç–∞–π—Å–∫–∏–π (CN)', code: 'CN' },
    ];

    let statusChart = null;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç —Ä—É—Å—Å–∫–∏–º
    function isRussian(text) {
        if (!text || text.trim().length === 0) return false;
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä—É—Å—Å–∫–∏—Ö –±—É–∫–≤
        const russianPattern = /[–ê-–Ø–∞-—è–Å—ë]/;
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ—Å—Ç–æ–∏—Ç –ª–∏ —Å—Ç—Ä–æ–∫–∞ —Ç–æ–ª—å–∫–æ –∏–∑ —Ü–∏—Ñ—Ä
        const onlyDigits = /^\d+$/.test(text.trim());
        return russianPattern.test(text) || onlyDigits;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ TSV —Ñ–∞–π–ª–∞
    // –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫ —Ñ–æ—Ä–º–∞—Ç–∞ { id, text }
    function parseTSV(text) {
        const lines = text.split(/\r?\n/).filter(l => l.length > 0);
        if (lines.length === 0) return [];

        const header = lines[0].split('\t');
        const idIndex = header.indexOf('ID');
        const textIndex = header.indexOf('OriginalText');
        const idCol = idIndex >= 0 ? idIndex : 0;
        const txtCol = textIndex >= 0 ? textIndex : 1;

        const rows = [];
        for (let i = 1; i < lines.length; i++) {
            const parts = lines[i].split('\t');
            if (parts.length <= Math.max(idCol, txtCol)) continue;
            const id = (parts[idCol] || '').trim();
            if (!id) continue;
            const txt = parts[txtCol] || '';
            rows.push({ id, text: txt });
        }
        return rows;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function calculateStats(rows) {
        let total = rows.length;
        let ru = 0;
        let en = 0;
        let empty = 0;

        for (const row of rows) {
            const text = row.text || '';
            if (text.trim().length === 0) {
                empty++;
            } else if (isRussian(text)) {
                ru++;
            } else {
                en++;
            }
        }

        const ruPercent = total > 0 ? ((ru / total) * 100).toFixed(1) : 0;
        const enPercent = total > 0 ? ((en / total) * 100).toFixed(1) : 0;

        return { total, ru, en, empty, ruPercent, enPercent };
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    function updateStats(elementPrefix, stats) {
        const totalEl = document.getElementById(`${elementPrefix}Total`);
        const ruEl = document.getElementById(`${elementPrefix}RU`);
        const enEl = document.getElementById(`${elementPrefix}EN`);
        const emptyEl = document.getElementById(`${elementPrefix}Empty`);
        const ruPercentEl = document.getElementById(`${elementPrefix}RUPercent`);
        const enPercentEl = document.getElementById(`${elementPrefix}ENPercent`);

        if (totalEl) totalEl.textContent = stats.total.toLocaleString();
        if (ruEl) ruEl.textContent = stats.ru.toLocaleString();
        if (enEl) enEl.textContent = stats.en.toLocaleString();
        if (emptyEl) emptyEl.textContent = stats.empty.toLocaleString();
        if (ruPercentEl) ruPercentEl.textContent = `${stats.ruPercent}%`;
        if (enPercentEl) enPercentEl.textContent = `${stats.enPercent}%`;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å –≤ —Ä–∞–∑–º–µ—Ç–∫–µ)
        if (elementPrefix === 'main') {
            const bar = document.getElementById('mainRUProgress');
            const label = document.getElementById('mainRUPercentBar');
            if (bar) bar.style.width = `${stats.ruPercent}%`;
            if (label) label.textContent = `${stats.ruPercent}%`;
        } else if (elementPrefix === 'cn') {
            const bar = document.getElementById('cnRUProgress');
            const label = document.getElementById('cnRUPercentBar');
            if (bar) bar.style.width = `${stats.ruPercent}%`;
            if (label) label.textContent = `${stats.ruPercent}%`;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
    async function loadFile(url) {
        try {
            const res = await fetch(url);
            if (!res.ok) {
                throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ${url}`);
            }
            const text = await res.text();
            return parseTSV(text);
        } catch (e) {
            console.error(e);
            throw e;
        }
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    async function loadAndProcess() {
        const loadingInfo = document.getElementById('loadingInfo');
        const preloader = document.getElementById('preloader');
        const preloaderBar = document.getElementById('preloaderBar');
        const preloaderText = document.getElementById('preloaderText');

        const setPreloader = (percent, text) => {
            if (preloaderBar) {
                preloaderBar.style.width = `${percent}%`;
            }
            if (preloaderText) {
                preloaderText.textContent = text;
            }
        };

        if (preloader) {
            preloader.classList.remove('opacity-0');
        }

        loadingInfo.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...';
        setPreloader(5, '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');

        try {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
            const aiSelect = document.getElementById('aiFileSelect');
            const langSelect = document.getElementById('langFileSelect');
            const hasAi = aiSelect && aiSelect.value !== '-1';
            const langIndex = langSelect ? parseInt(langSelect.value, 10) || 0 : 0;
            const langCfg = languageFiles[Math.max(0, Math.min(langIndex, languageFiles.length - 1))];

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –ø–µ—Ä–µ–≤–æ–¥–∞ (–Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è)
            loadingInfo.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ translation_ru.tsv...';
            setPreloader(15, '–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞...');
            const mainRows = await loadFile('../translation_ru.tsv');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫–æ–≤–æ–π —Ñ–∞–π–ª
            loadingInfo.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ ${langCfg.file}...`;
            setPreloader(40, '–ó–∞–≥—Ä—É–∑–∫–∞ —è–∑—ã–∫–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞...');
            const langRows = await loadFile(`../${langCfg.file}`);

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π AI-—Ñ–∞–π–ª (–µ—Å–ª–∏ –æ–Ω –≤—ã–±—Ä–∞–Ω)
            let aiRows = [];
            if (hasAi) {
                const aiIndex = parseInt(aiSelect.value, 10) || 0;
                const aiCfg = aiFiles[Math.max(0, Math.min(aiIndex, aiFiles.length - 1))];
                loadingInfo.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ translates_ai/${aiCfg.file}...`;
                setPreloader(65, '–ó–∞–≥—Ä—É–∑–∫–∞ AI-—Ñ–∞–π–ª–∞...');
                aiRows = await loadFile(`../translates_ai/${aiCfg.file}`);
            }

            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞
            loadingInfo.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
            setPreloader(80, '–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
            const mainStats = calculateStats(mainRows);
            updateStats('main', mainStats);

            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
            const langStats = calculateStats(langRows);
            updateStats('cn', langStats);

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ø–æ–¥–ø–∏—Å–∏ –ø–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫–æ–≤–æ–π —Ñ–∞–π–ª
            const langTitle = document.getElementById('langStatsTitle');
            const langLabel = document.getElementById('cnLangLabel');
            if (langTitle) langTitle.textContent = `–ü—Ä–µ–¥–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ (${langCfg.name})`;
            if (langLabel) langLabel.textContent = langCfg.name;

            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è AI-—Ñ–∞–π–ª–∞
            const aiStats = calculateStats(aiRows);

            // –†–∞—Å—á—ë—Ç –ø–æ–∫—Ä—ã—Ç–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ —Ä—É—Å—Å–∫–∏–º –ø–µ—Ä–µ–≤–æ–¥–æ–º (–æ—Å–Ω–æ–≤–Ω–æ–π + AI)
            const mainMap = new Map(mainRows.map(r => [r.id, r.text]));
            const aiMap = new Map(aiRows.map(r => [r.id, r.text]));
            let coveredInLang = 0;
            for (const row of langRows) {
                const mainTxt = mainMap.get(row.id) || '';
                const aiTxt = aiMap.get(row.id) || '';
                if (isRussian(mainTxt) || isRussian(aiTxt)) {
                    coveredInLang++;
                }
            }
            const coveredPercent = langStats.total > 0 ? ((coveredInLang / langStats.total) * 100).toFixed(1) : 0;
            const cnRUEl = document.getElementById('cnRU');
            const cnRUPercentEl = document.getElementById('cnRUPercent');
            if (cnRUEl) cnRUEl.textContent = coveredInLang.toLocaleString();
            if (cnRUPercentEl) cnRUPercentEl.textContent = `${coveredPercent}%`;

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–∞—à–∏–Ω–Ω–æ–º—É RU (AI) –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞
            const extraRu = hasAi ? Math.max(aiStats.ru - mainStats.ru, 0) : 0;
            const ruShareInAi = hasAi && aiStats.total > 0 ? ((aiStats.ru / aiStats.total) * 100).toFixed(1) : 0;
            // –î–æ–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ RU –æ—Ç –º–∞—à–∏–Ω–Ω–æ–≥–æ RU (–≤–º–µ–Ω—è–µ–º—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç, –Ω–µ –±–æ–ª—å—à–µ 100)
            const ruRatio = hasAi && aiStats.ru > 0 ? ((mainStats.ru / aiStats.ru) * 100).toFixed(1) : 0;
            const extraRuShareInAi = hasAi && aiStats.total > 0 ? ((extraRu / aiStats.total) * 100).toFixed(1) : 0;

            if (hasAi) {
                document.getElementById('uniqueTotal').textContent = extraRu.toLocaleString();
                document.getElementById('uniqueRU').textContent = aiStats.ru.toLocaleString();
                document.getElementById('uniqueRUPercent').textContent = `${ruShareInAi}%`;
                document.getElementById('uniqueEN').textContent = mainStats.ru.toLocaleString();
                document.getElementById('uniqueENPercent').textContent = `${ruRatio}%`;
                document.getElementById('uniqueEmpty').textContent = `${extraRuShareInAi}%`;
            } else {
                document.getElementById('uniqueTotal').textContent = '‚Äî';
                document.getElementById('uniqueRU').textContent = '‚Äî';
                document.getElementById('uniqueRUPercent').textContent = '‚Äî';
                document.getElementById('uniqueEN').textContent = '‚Äî';
                document.getElementById('uniqueENPercent').textContent = '‚Äî';
                document.getElementById('uniqueEmpty').textContent = '‚Äî';
            }

            // –î–∏–∞–≥—Ä–∞–º–º–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–µ—Ä–µ–≤–æ–¥–∞
            const machineOnly = extraRu;// —Å—Ç—Ä–æ–∫–∏ —Ç–æ–ª—å–∫–æ —Å –º–∞—à–∏–Ω–Ω—ã–º –ø–µ—Ä–µ–≤–æ–¥–æ–º (AI)
            const edited = mainStats.ru;// –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (–æ—Å–Ω–æ–≤–Ω–æ–π) –ø–µ—Ä–µ–≤–æ–¥
            const rawUntranslated = (langStats.en + langStats.empty) - extraRu - mainStats.ru;
            const untranslated = Math.max(rawUntranslated, 0);

            const ctx = document.getElementById('statusChart').getContext('2d');
            if (statusChart) {
                statusChart.destroy();
            }
            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['–ú–∞—à–∏–Ω–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥', '–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥', '–ù–µ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ'],
                    datasets: [{
                        data: [machineOnly, edited, untranslated],
                        backgroundColor: ['#22d3ee', '#4ade80', '#e879f9'],
                        borderColor: '#0f172a',
                        borderWidth: 2,
                        hoverOffset: 6
                    }]
                },
                options: {
                    plugins: {
                        legend: { display: false },
                    },
                    cutout: '60%',
                }
            });

            document.getElementById('legendMachine').textContent =
                `–ú–∞—à–∏–Ω–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥: ${machineOnly.toLocaleString()}`;
            document.getElementById('legendEdited').textContent =
                `–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥: ${edited.toLocaleString()}`;
            document.getElementById('legendUntranslated').textContent =
                `–ù–µ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ: ${untranslated.toLocaleString()}`;

            loadingInfo.textContent = `‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –û—Å–Ω–æ–≤–Ω–æ–π: ${mainStats.total.toLocaleString()} —Å—Ç—Ä–æ–∫, AI: ${aiStats.total.toLocaleString()} —Å—Ç—Ä–æ–∫, –ú–∞—à–∏–Ω–Ω—ã–π RU —Å–≤–µ—Ä—Ö –æ—Å–Ω–æ–≤–Ω–æ–≥–æ: ${extraRu.toLocaleString()} —Å—Ç—Ä–æ–∫`;
            setPreloader(100, '–ì–æ—Ç–æ–≤–æ');
            setTimeout(() => {
                if (preloader) {
                    preloader.classList.add('opacity-0');
                }
            }, 600);
        } catch (e) {
            console.error(e);
            loadingInfo.textContent = `‚ùå –û—à–∏–±–∫–∞: ${e.message}`;
            setPreloader(0, '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤ –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    function initSelectors() {
        const aiSelect = document.getElementById('aiFileSelect');
        const langSelect = document.getElementById('langFileSelect');

        if (aiSelect && aiSelect.options.length === 0) {
            // –û–ø—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –±–µ–∑ AI-–ø–µ—Ä–µ–≤–æ–¥–∞
            const noneOpt = document.createElement('option');
            noneOpt.value = '-1';
            noneOpt.textContent = '–ù–µ—Ç (–±–µ–∑ AI-–ø–µ—Ä–µ–≤–æ–¥–∞)';
            aiSelect.appendChild(noneOpt);

            aiFiles.forEach((cfg, index) => {
                const opt = document.createElement('option');
                opt.value = String(index);
                opt.textContent = cfg.name;
                aiSelect.appendChild(opt);
            });
        }

        if (langSelect && langSelect.options.length === 0) {
            languageFiles.forEach((cfg, index) => {
                const opt = document.createElement('option');
                opt.value = String(index);
                opt.textContent = cfg.name;
                langSelect.appendChild(opt);
            });
        }

        if (aiSelect) {
            aiSelect.addEventListener('change', () => {
                loadAndProcess();
            });
        }
        if (langSelect) {
            langSelect.addEventListener('change', () => {
                loadAndProcess();
            });
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    document.getElementById('btnRefresh').addEventListener('click', () => {
        loadAndProcess();
    });

    // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    initSelectors();
    loadAndProcess();
</script>
</body>
</html>

