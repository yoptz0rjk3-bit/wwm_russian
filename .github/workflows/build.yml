name: Build Translation Release

# –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–æ–º –Ω–∞ –ø—É—à–µ, —É –º–µ–Ω—è –≤ —Ñ–æ—Ä–∫-–≤–µ—Ä—Å–∏–∏ —Ç–∞–∫, –ø–æ—Ç–æ–º—É —É–±–∏—Ä–∞—é —Å—Ç–∞–≤–ª—é –ø–æ –∫–Ω–æ–ø–∫–µ –µ—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å —Å–¥–µ–ª–∞—Ç—å –∞–≤—Ç–æ –±–∏–ª–¥
# –î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–∞, –Ω—É–∂–Ω–æ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ä–µ–ª–∏–∑ —Å game-vXXXX —Ç—ç–≥–æ–º –∏ –∑–∞–ª–∏—Ç—å —Ç—É–¥–∞ –ª—é–±—ã–µ —Ñ–∞–π–ª—ã –∏–≥—Ä—ã –¥–æ–±–∞–≤–∏–≤ –∏–º .bin –≤ –∫–æ–Ω—Ü–µ.
on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'translation_ru.tsv'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyzstd

      - name: Download latest game release
        run: |
          mkdir -p ./game_files
          LATEST_TAG=$(gh release list --exclude-drafts --exclude-pre-releases | grep "game-v" | awk '{print $3}')
          echo "Latest game release: $LATEST_TAG"
          gh release download "$LATEST_TAG" \
            --pattern "*.bin" \
            --dir ./game_files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build translation
        run: |
          python .github/scripts/wwm_build.py \
            --input ./game_files/*.bin \
            --translation translation_ru.tsv \
            --output ./release/ \
            --workdir ./work/

      - name: Create release archive
        run: |
          cd release/
          zip -r ../translation_release.zip *
          cd ..

      - name: Create Translation Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: translation-${{ github.sha }}
          name: üá∑üá∫ –†—É—Å—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥ - –≤–µ—Ä—Å–∏—è ${{ github.event.head_commit.timestamp }}
          files: |
            release/*
            translation_release.zip
          body: |
            ## üá∑üá∫ –†—É—Å—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥ –¥–ª—è Where Winds Meet
            
            **–î–∞—Ç–∞ —Å–±–æ—Ä–∫–∏:** ${{ github.event.head_commit.timestamp }}
            
            ---
            
            ### üìù –ß—Ç–æ –≤ —Ä–µ–ª–∏–∑–µ:
            - `translate_words_map_en` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –ø–µ—Ä–µ–≤–æ–¥
            - `translate_words_map_en_diff` ‚Äî –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥
            - `translation_release.zip` ‚Äî –∞—Ä—Ö–∏–≤ —Å–æ –≤—Å–µ–º–∏ —Ñ–∞–π–ª–∞–º–∏
            
            ### üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
            
            **–°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ Steam**
            ```
            Steam\steamapps\common\Where Winds Meet\Package\HD\oversea\locale
            ```
            –ü–æ–º–µ—Å—Ç–∏—Ç—å —Ñ–∞–π–ª—ã —Å –∑–∞–º–µ–Ω–æ–π
            
            **–°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ –ª–∞—É–Ω—á–µ—Ä**
            ```
            \wwm\wwm_standard\LocalData\Patch\HD\oversea\locale
            ```
            –ü–æ–º–µ—Å—Ç–∏—Ç—å —Ñ–∞–π–ª—ã —Å –∑–∞–º–µ–Ω–æ–π
            
            ### üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞—Ä—Ö–∏–≤–∞:
            ```
            translation_release/
            ‚îú‚îÄ‚îÄ translate_words_map_en
            ‚îî‚îÄ‚îÄ translate_words_map_en_diff
            ```
            
            ### ‚úÖ –ü—Ä–æ—Ü–µ—Å—Å —Å–±–æ—Ä–∫–∏:
            - –ü—Ä–∏–º–µ–Ω—ë–Ω –ø–µ—Ä–µ–≤–æ–¥ –∏–∑ `translation_ru.tsv`
            - –°–±–æ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            
            ---
            
            **–ü—Ä–∏—è—Ç–Ω–æ–π –∏–≥—Ä—ã!**